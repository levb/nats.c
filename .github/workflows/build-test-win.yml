name: build and test
on:
  workflow_call:
    inputs:
      arch:
        type: string
        default: "64"
      compiler:
        type: string
        default: "gcc"
      name:
        type: string
        description: "name of the build"
        default: "build"
      quick_test:
        type: string
        default: "OFF"
      server_version:
        type: string
        description: "nats-server version to test with"
        default: "latest"
      streaming:
        type: string
        default: "ON"
      tls:
        type: string
        default: "ON"
      type:
        type: string
        description: "Debug or Release."
        default: "Release"

defaults:
  run:
    shell: bash --noprofile --norc -x -eo pipefail {0}

jobs:
  build-test:
    runs-on: windows-latest
    name: ${{ inputs.name }}
    steps:
      - name: Checkout nats.c
        uses: actions/checkout@v3

      - name: "Checkout dependencies (nats.c.deps)"
        uses: actions/checkout@v3
        with:
          repository: nats-io/nats.c.deps
          path: deps

      # configure the cmake flags and NATS_... environment variables
      - id: cmake-flags
        name: Configure cmake flags
        env:
          flags: -DNATS_BUILD_ARCH=${{ inputs.arch }}
            -DCMAKE_BUILD_TYPE=${{ inputs.type }}
            -DNATS_BUILD_STREAMING=${{ inputs.streaming }}
            -DNATS_BUILD_WITH_TLS=${{ inputs.tls }}
            -DNATS_PROTOBUF_DIR=${{ github.workspace}}/deps/pbuf
            -DNATS_BUILD_USE_SODIUM=ON
            -DNATS_SODIUM_DIR=${{ github.workspace}}/deps/sodium
        run: |
          export
          echo ${GITHUB_WORKSPACE}
          echo '${{ github.workspace}}' 
          echo "flags=$flags" >> $GITHUB_OUTPUT
          echo "CC=${{ inputs.compiler }}" >> $GITHUB_ENV

      # otherwise, configure cmake, build, archive and upload
      - name: CMake
        run: |
          mkdir -p build
          cd build
          cmake .. ${{ steps.cmake-flags.outputs.flags }}
          make rebuild_cache && make